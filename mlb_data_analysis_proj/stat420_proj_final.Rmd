---
title: 'STAT 420: Data Analysis Project, Fall 2016'
author: "Aaron Ray (aaronwr2), Aaron Rogers (aaronrr2), Michael Chan (mhchan3), Michael Johnson (mjohns44)"
date: 'Monday, November 14, 2016'
output:
  html_document:
    toc: yes
---

# Introduction

## Project Members

- Aaron Ray (aaronwr2)
- Aaron Rogers (aaronrr2)
- Michael Chan (mhchan3)
- Michael Johnson (mjohns44)

## Proposed title for the project

**A Statistical Approach to Predicting Major League Baseball Team Success**

## Project Description

Major League Baseball was the first introduction many people in the United States had to the field of statistics.  To this day, children and adults alike recite batting averages for their favorite players, measure pitchers by their earned run average, and talk about how much money specific players earn.  Everyday people have spirited debates about baseball statistics, arguing for their own theories of which statistics predict victory on the baseball field. 

This project will parse over 140 years of data to find which combinations of baseball statistics have been the most accurate in predicting the championship team.

## Description of Dataset

The source of the data for this project: http://www.seanlahman.com/baseball-archive/statistics/

This dataset contains pitching, hitting, and fielding statistics for Major League Baseball from 1871 through 2015.  It includes data from the two current leagues (American and National), the four other "major" leagues (American Association, Union Association, Players League, and Federal League), and the National Association of 1871-1875. For more details, see [readme2014.txt](http://seanlahman.com/files/database/readme2014.txt)

### Potential Response Variables

- `Rank`           Position in final standings
- `WSWin`          World Series Winner (Y or N)
- `LgWin`          League Champion(Y or N)

### Selected Predictor Variables

- `yearID`         Year
- `W`              Wins
- `L`              Losses
- `salary`         Total Salary of the team
- `totalSalary`    Total Salary of all teams in that year
- `pctSalary`      Total Salary of the team as a proportion of the total salary of all teams in that year

## Analysis Ideas

Find out which predictors are useful for predicting rank or winning the Championship - % Salaries, Wins, Losses, etc.  The project will explore the effectiveness of different models (linear, polynomial, additive, and interaction).

## Sample Data

The following `R` code loads the `Teams.csv` and `Salaries.csv`. Some data manipulation is performed to compute the total salary and the percent of total salary.

```{r}
teams = read.csv("Teams.csv")
salaries = read.csv("Salaries.csv")

# Add pctSalary
salries_by_team_year = aggregate(x=salaries$salary, by = list(salaries$teamID, salaries$yearID), FUN=sum)
colnames(salries_by_team_year) = c("teamID", "yearID", "salary")

mlb_data = merge(teams, salries_by_team_year, by=c("yearID", "teamID") )
mlb_data$salary = as.numeric(mlb_data$salary)

total_salary_by_year = aggregate(mlb_data$salary, by = list(mlb_data$yearID), FUN=sum)
colnames(total_salary_by_year) = c("yearID", "totalSalary")

mlb_data = merge(mlb_data, total_salary_by_year, by = c("yearID"))
mlb_data$pctSalary = mlb_data$salary / mlb_data$totalSalary

# Add winPct
mlb_data$WinPct = mlb_data$W/mlb_data$G

```

### Add run differential. 

One of the hypothesis we want to test is whether the Pythagorean Theorem of Baseball holds.  The Pythagoream Theorem suggests the run differenial is a good predictor of win percentage

See http://www.baseball-reference.com/bullpen/Pythagorean_Theorem_of_Baseball

```{r}
mlb_data$runDifferiential = mlb_data$R^2 / (mlb_data$R^2 + mlb_data$RA^2)
```


### Identify predictors that have potential prediction values in the dataset

#### Remove variables that are descriptive
```{r}
mlb_lm_data = mlb_data[, setdiff(colnames(mlb_data), c("teamID", "lgID", "franchID", "divID", "teamIDBR", "teamIDlahman45", "teamIDretro", "park", "name"))]
head(mlb_lm_data)

```

#### Remove variables that are essentially other repsonses
```{r}
mlb_lm_data = mlb_lm_data[, setdiff(colnames(mlb_lm_data), c("L", "Rank", "DivWin", "WCWin", "LgWin", "WSWin"))]
head(mlb_lm_data)

```

#### Remove variables that are linearly dependent
```{r}
mlb_lm_data = mlb_lm_data[, setdiff(colnames(mlb_lm_data), c("salary", "totalSalary", "W", "ERA"))]
head(mlb_lm_data)
```

#### Remove variables that are relatively the same across all teams
```{r}
mlb_lm_data = mlb_lm_data[, setdiff(colnames(mlb_lm_data), c("G", "Ghome"))]
head(mlb_lm_data)

```

#### Remove variables that are used to calculate run differential
```{r}

mlb_lm_data = mlb_lm_data[, setdiff(colnames(mlb_lm_data), c("R", "RA"))]
head(mlb_lm_data)
```


### Only use from Modern Era
```{r}
mlb_lm_year_filtered_data = mlb_lm_data[mlb_lm_data$yearID>2000,]
mlb_lm_year_filtered_data = mlb_lm_year_filtered_data[, setdiff(colnames(mlb_lm_year_filtered_data), c("yearID"))]
head(mlb_lm_year_filtered_data)
```


### Use Vif to investigate the correlation of variables
```{r}
library(faraway)
vif(mlb_lm_year_filtered_data)
```

There are a number of variables with high VIF.  Therefore, we expect the model selection process will eliminate a large number of those variables.

```{r}
  findBestModel = function(startYear) {
    mlb_lm_year_filtered_data = mlb_lm_data[mlb_lm_data$yearID>=startYear,]
    mlb_lm_year_filtered_data = mlb_lm_year_filtered_data[, setdiff(colnames(mlb_lm_year_filtered_data), c("yearID"))]
    n = nrow(mlb_lm_year_filtered_data)
    mlb_lm_both_bic = step(lm(WinPct ~ 1, data=mlb_lm_year_filtered_data), WinPct ~    (AB+H+X2B+X3B+HR+BB+SO+SB+CS+HBP+SF+ER+CG+SHO+SV+IPouts+HA+HRA+BBA+SOA+E+DP+FP+attendance+BPF+PPF+pctSalary+runDifferiential) ^ 2, direction = "both", k = log(n), trace = 0) 
    mlb_lm_both_bic
  }
```

## Use Stepwise BIC to find a "good" model for year 2001 to 2015
```{r}
mlb_lm_both_bic = findBestModel(2001)
(mlb_lm_both_bic_summary = summary(mlb_lm_both_bic))
```

The Model selection process using forward BIC selected a relative small model.  As expected, the `runDifferiential` is a good predictor of the win percentage.  The p-val also shows that it is very significant.  The other predictors are `SV`- `Saves`, `BB` - `Walks by batters`, `CG` - `Complete games` and `pctSalary` - `The percentage of salary`.  Of the predictors, the `runDifferiential` and `pctSalary` have the greatest prediction power.

## Salary Effect on winning percentage over time

The following code select the "best" with end year fixed at 2015, but with start year ranged from 1900 to 2015.

```{r warning=FALSE}
# runPctSalaryTimeEffectAnalysis
maxNumYears = 2015 - 1900 + 1
pctSalaryTimeEffectAnalysis = matrix(rep(0, maxNumYears*2), nrow = maxNumYears)
colnames(pctSalaryTimeEffectAnalysis) = c("startYear", "hasPctSalary")
for (numYears in 1:maxNumYears) {
  startYear=2015-numYears + 1
  mlb_lm_both_bic = findBestModel(startYear)
  pctSalaryTimeEffectAnalysis[maxNumYears - numYears + 1, 1] = startYear
  if ("pctSalary" %in% names(mlb_lm_both_bic$coefficients)) {
    pctSalaryTimeEffectAnalysis[maxNumYears - numYears + 1, 2] = 1
  } else {
    pctSalaryTimeEffectAnalysis[maxNumYears - numYears + 1, 2] = 0
  }
}
pctSalaryTimeEffectAnalysis=as.data.frame(pctSalaryTimeEffectAnalysis)
```

The following time range (with startYear to 2015) include pctSalary in the "best" model selection:
```{r}
pctSalaryTimeEffectAnalysis$startYear[pctSalaryTimeEffectAnalysis$hasPctSalary == 1]
```

## Main model selected for further analysis

Data from 2001 to 2015

```{r}
mlb_lm_both_bic = findBestModel(2001)
mlb_lm_both_bic_summary = summary(mlb_lm_both_bic)
mlb_lm_both_bic$coefficients
```

## Assumption Analysis
```{r echo=FALSE}
library(lmtest)

plotResidual = function(lmModel, pointcol="dodgerblue", linecol="darkorange") {
  plot(fitted(lmModel),
       resid(lmModel),
       col = pointcol,
       xlab = "Fitted",
       ylab = "Residuals"
       )
  abline(h = 0, col = linecol, lwd = 2)
}

plotQQ = function(lmModel, pointcol="dodgerblue", linecol="darkorange") {
  qqnorm(resid(lmModel), main = "Normal Q-Q Plot", col = pointcol)
  qqline(resid(lmModel), col = linecol, lwd = 2)
}
calc_loocv_rmse = function(model) {
  sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}
```




### Constant Variance Assumption

#### Fitted versus Residuals Plot
```{r}
plotResidual(mlb_lm_both_bic)
```

#### Breusch-Pagan Test

```{r}
(bptest_mlb_lm_both_bic = bptest(mlb_lm_both_bic))
```

From the Breusch-Pagan test, the p-val, `r bptest_mlb_lm_both_bic$p.value` , is relatively large, which means we cannot reject the null hypothesis of Homoscedasticity (constant variance.)  In addition, the residual plots show the spread of residuals are evenly distributed.  There, we conclude that the constant variance is not violated.

### Normality Assumption

#### Normal Q-Q Plot
```{r}
plotQQ(mlb_lm_both_bic)
```

#### Shapiro-Wilk Test

```{r}
(shapiro_mlb_lm_both_bic = shapiro.test(resid(mlb_lm_both_bic)))
```

The normality assumption for this model has not been violated.  From the q-q plot, the residuals are more or less on the qqline.  From the Shapiro-Wilk Test, the p value, `r shapiro_mlb_lm_both_bic$p.value`, is large, hence, we cannot reject the null hypothesis of the data following a normal distribution.


## Other Analysis

- Number of Influential observations
```{r}
num_data = length(mlb_lm_both_bic$residuals)
num_influential = sum(cooks.distance(mlb_lm_both_bic) > 4 / length(cooks.distance(mlb_lm_both_bic)))
num_influential
```

- The portion of Influential observations is:

```{r}
num_influential / num_data
```

- Number of High leverage observations
```{r}
num_high_leverage = sum(hatvalues(mlb_lm_both_bic) > 2 * mean(hatvalues(mlb_lm_both_bic)))
num_high_leverage
```

- The portion of High leverage observations is:
```{r}
num_high_leverage / num_data
```


## ANOVA

The Pythagorean Theorem of Baseball states that the pct win can be predicted by runDifferential.  Let's see whether the simplest model is better than the slightly bigger model chosen by stepwise BIC

```{r}
    mlb_lm_year_filtered_data = mlb_lm_data[mlb_lm_data$yearID>=2001,]
    mlb_lm_year_filtered_data = mlb_lm_year_filtered_data[, setdiff(colnames(mlb_lm_year_filtered_data), c("yearID"))]
    lm_small = lm(WinPct ~ runDifferiential, data=mlb_lm_year_filtered_data)
    
    (mlb_lm_anova = anova(lm_small, mlb_lm_both_bic))
    mlb_lm_anova_p_val = mlb_lm_anova$`Pr(>F)`[2]
```

With p-val, `r mlb_lm_anova_p_val`, we reject the Null Hypothesis of $\beta_{SV}$=$\beta_{BB}$=$\beta_{CG}$=$\beta_{pctSalary}$=0

